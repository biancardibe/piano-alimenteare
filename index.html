<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Piano Alimentare Settimanale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            padding-top: 60px; /* Spazio per l'header fisso */
            overflow: hidden; /* Previene lo scroll del body durante lo scroll interno */
        }
        #app-wrapper {
            height: calc(100vh - 60px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        #sticky-header {
            transition: transform 0.3s ease, opacity 0.3s ease;
            transform: translateY(-100%);
            opacity: 0;
        }
        #sticky-header.visible {
            transform: translateY(0);
            opacity: 1;
        }
        .meal-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .nav-button.active {
            background-color: #1D4ED8; /* bg-blue-700 */
            color: white;
            font-weight: 600;
        }
        .day-nav-button.active {
            background-color: #3B82F6; /* bg-blue-500 */
            color: white;
            border-color: #3B82F6; /* border-blue-500 */
        }
        .view-button.active {
            color: #1D4ED8; /* text-blue-700 */
            border-bottom-color: #1D4ED8; /* border-blue-700 */
        }
        .shopping-item input[type="checkbox"]:checked + label {
            text-decoration: line-through;
            color: #9CA3AF;
        }
        /* Stili per la navigazione a schede interattiva */
        #plan-view-container {
            perspective: 1200px;
            overflow: hidden;
            position: relative;
        }
        .day-card {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            will-change: transform, opacity;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }
        .day-card.no-transition {
            transition: none;
        }
        .day-card.with-transition {
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Header Fisso -->
    <div id="sticky-header" class="fixed top-0 left-0 right-0 bg-white/80 backdrop-blur-sm shadow-md h-[60px] flex items-center justify-center px-4 z-20">
        <h2 class="text-lg font-bold text-gray-800">
            <span id="sticky-week"></span> - <span id="sticky-day"></span>
        </h2>
    </div>

    <div id="app-wrapper">
      <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="text-center mb-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Il Tuo Piano Alimentare</h1>
            <p class="mt-2 text-lg text-gray-600">4 settimane di alimentazione bilanciata</p>
        </header>

        <nav id="view-nav" class="flex justify-center border-b-2 border-gray-200 mb-6">
            <button id="plan-view-btn" class="view-button active">Piano Alimentare</button>
            <button id="list-view-btn" class="view-button">Lista della Spesa</button>
        </nav>

        <nav id="week-nav" class="flex justify-center bg-white p-2 rounded-xl shadow-md mb-6 sticky top-2 z-10">
        </nav>
        
        <div id="content-container">
            <div id="plan-view-wrapper">
                <nav id="day-nav" class="flex flex-wrap justify-center gap-2 mb-8"></nav>
                <div id="plan-view-container" class="relative min-h-[500px]">
                    <!-- Le schede dei giorni verranno inserite qui -->
                </div>
            </div>
            
            <div id="list-view-container" class="hidden"></div>
        </div>

        <footer class="text-center mt-12 text-sm text-gray-500">
            <p>Questo piano alimentare è stato generato sulla base delle tue indicazioni. Consulta sempre un professionista.</p>
        </footer>

      </div>
    </div>

    <script>
        const mealPlan = {
            settimana1: {
                lun: {
                    colazione: { nome: "Yogurt greco intero e Muesli con Banana", grammatura: "125g + 30g + 150g", descrizione: "Yogurt greco con muesli e una banana a fette." },
                    merenda: { nome: "Kiwi e Mandorle", grammatura: "150g + 30g", descrizione: "Due kiwi freschi accompagnati da mandorle secche." },
                    spuntino_extra: { nome: "Semi di zucca", grammatura: "20g", descrizione: "Spuntino extra durante la giornata." },
                    pranzo: { nome: "Pasta Senatore Cappelli con Ceci e Zucchine", grammatura: "80g + 60g + 200g", descrizione: "Pasta condita con ceci e zucchine saltate. Condire con 20g di olio EVO e 5g di olio di lino." },
                    cena: { nome: "Petto di tacchino, Bieta e Mirtilli", grammatura: "150g + 100g + 125g", descrizione: "Tacchino al forno con bieta lessa. Concludere con mirtilli freschi." }
                },
                mar: {
                    colazione: { nome: "Pane secco, burro, marmellata e Kiwi", grammatura: "90g + 150g", descrizione: "Pane secco con burro di centrifuga, marmellata biologica e due kiwi." },
                    merenda: { nome: "Banana e Noci", grammatura: "150g + 30g", descrizione: "Una banana fresca e noci secche." },
                    spuntino_extra: { nome: "Semi di zucca", grammatura: "20g", descrizione: "Spuntino extra durante la giornata." },
                    pranzo: { nome: "Riso basmati con Lenticchie e Carote", grammatura: "80g + 60g + 100g", descrizione: "Riso basmati con lenticchie e carote. Condire con 20g olio EVO e 5g olio di lino." },
                    cena: { nome: "Sgombro, Spinaci e Banana", grammatura: "150g + 100g + 150g", descrizione: "Sgombro al naturale con spinaci al vapore. Concludere con una banana." }
                },
                mer: {
                    colazione: { nome: "Ricotta di vacca, Muesli e Mirtilli", grammatura: "80g + 30g + 125g", descrizione: "Ricotta fresca con muesli e mirtilli freschi." },
                    merenda: { nome: "Banana e Anacardi", grammatura: "150g + 30g", descrizione: "Una banana e anacardi tostati." },
                    spuntino_extra: { nome: "Semi di zucca", grammatura: "20g", descrizione: "Spuntino extra durante la giornata." },
                    pranzo: { nome: "Farro con Piselli e Pomodori", grammatura: "80g + 60g + 200g", descrizione: "Insalata di farro con piselli freschi e pomodori. Condire con 20g olio EVO." },
                    cena: { nome: "Salmone fresco, Broccoletti e Kiwi", grammatura: "150g + 200g + 150g", descrizione: "Trancio di salmone al vapore con broccoletti. Concludere con due kiwi." }
                },
                gio: {
                    colazione: { nome: "Latte di capra, Muesli e Banana", grammatura: "200g + 30g + 150g", descrizione: "Tazza di latte di capra con muesli senza zuccheri aggiunti e una banana." },
                    merenda: { nome: "Mirtilli e Nocciole", grammatura: "125g + 30g", descrizione: "Coppetta di mirtilli freschi e nocciole secche." },
                    spuntino_extra: { nome: "Semi di zucca", grammatura: "20g", descrizione: "Spuntino extra durante la giornata." },
                    pranzo: { nome: "Grano saraceno con Fagioli e Zucca gialla", grammatura: "80g + 60g + 200g", descrizione: "Insalata di grano saraceno con fagioli e zucca. Condire con 20g olio EVO." },
                    cena: { nome: "Vitellone, Asparagi e Mirtilli", grammatura: "150g + 100g + 125g", descrizione: "Bistecca di vitellone con asparagi al vapore. Concludere con mirtilli." }
                },
                ven: {
                    colazione: { nome: "Pane secco, burro, marmellata e Banana", grammatura: "90g + 150g", descrizione: "Pane secco con burro, marmellata e una banana." },
                    merenda: { nome: "Mirtilli e Mandorle", grammatura: "125g + 30g", descrizione: "Una coppetta di mirtilli freschi e mandorle." },
                    spuntino_extra: { nome: "Semi di zucca", grammatura: "20g", descrizione: "Spuntino extra durante la giornata." },
                    pranzo: { nome: "Riso nero Venere con Sgombro e Zucchine", grammatura: "80g + 60g + 200g", descrizione: "Riso Venere con sgombro al naturale e zucchine grigliate. Condire con 20g olio EVO." },
                    cena: { nome: "Orata al forno, Peperoni e Kiwi", grammatura: "150g + 150g + 150g", descrizione: "Orata al cartoccio con peperoni arrostiti. Concludere con due kiwi." }
                },
                sab: {
                    colazione: { nome: "Ricotta di pecora, Muesli e Kiwi", grammatura: "80g + 30g + 150g", descrizione: "Ricotta fresca con muesli e due kiwi." },
                    merenda: { nome: "Fiocchi di latte e Semi di girasole", grammatura: "85g + 20g", descrizione: "Fiocchi di latte con semi di girasole." },
                    spuntino_extra: { nome: "Semi di zucca", grammatura: "20g", descrizione: "Spuntino extra durante la giornata." },
                    pranzo: { nome: "Grano saraceno con Funghi", grammatura: "80g + 150g", descrizione: "Grano saraceno con funghi prataioli trifolati. Condire con 20g olio EVO." },
                    cena: { nome: "Bistecca di maiale, Lattuga, Banana", grammatura: "150g + 100g + 150g", descrizione: "Bistecca di maiale alla griglia con lattuga. Concludere con una banana." }
                },
                dom: {
                    colazione: { nome: "Latte di pecora, Muesli e Banana", grammatura: "200g + 30g + 150g", descrizione: "Latte di pecora con muesli e una banana." },
                    merenda: { nome: "Banana e Noci", grammatura: "150g + 30g", descrizione: "Una banana non troppo matura e noci secche." },
                    spuntino_extra: { nome: "Semi di zucca", grammatura: "20g", descrizione: "Spuntino extra durante la giornata." },
                    pranzo: { nome: "Pasta Senatore Cappelli con Vongole e Zucchine", grammatura: "80g + 60g + 200g", descrizione: "Pasta con vongole al naturale e zucchine a cubetti. Condire con 20g olio EVO." },
                    cena: { nome: "Trota al forno, Fagiolini e Kiwi", grammatura: "150g + 100g + 150g", descrizione: "Trota al forno con fagiolini al vapore. Concludere con due kiwi." }
                }
            },
            settimana2: {
                lun: {
                    colazione: { nome: "Yogurt greco e Muesli con Kiwi", grammatura: "125g + 30g + 150g", descrizione: "Yogurt greco con muesli e due kiwi." },
                    merenda: { nome: "Banana e Nocciole", grammatura: "150g + 30g", descrizione: "Una banana fresca accompagnata da nocciole secche." },
                    spuntino_extra: { nome: "Semi di zucca", grammatura: "20g", descrizione: "Spuntino extra durante la giornata." },
                    pranzo: { nome: "Grano saraceno con Ceci e Zucchine", grammatura: "80g + 60g + 200g", descrizione: "Grano saraceno con ceci e zucchine al vapore. Condire con 20g olio EVO e 5g olio di lino." },
                    cena: { nome: "Polpo con patate e prezzemolo, Mirtilli", grammatura: "200g + 200g + 125g", descrizione: "Polpo bollito con patate lesse, condito con prezzemolo e olio. Concludere con mirtilli." }
                },
                mar: {
                    colazione: { nome: "Ricotta di vacca con Mirtilli", grammatura: "80g + 125g", descrizione: "Ricotta fresca servita con mirtilli freschi." },
                    merenda: { nome: "Banana e Mandorle", grammatura: "150g + 30g", descrizione: "Una banana fresca e mandorle." },
                    spuntino_extra: { nome: "Semi di zucca", grammatura: "20g", descrizione: "Spuntino extra durante la giornata." },
                    pranzo: { nome: "Riso basmati con Lenticchie e Zucca", grammatura: "80g + 60g + 200g", descrizione: "Riso basmati con lenticchie e cubetti di zucca gialla. Condire con 20g olio EVO." },
                    cena: { nome: "Fegato di bovino, Agretti e Kiwi", grammatura: "150g + 100g + 150g", descrizione: "Fegato saltato in padella con contorno di agretti. Concludere con due kiwi." }
                },
                 mer: {
                    colazione: { nome: "Ricotta di pecora, Muesli e Banana", grammatura: "80g + 30g + 150g", descrizione: "Ricotta di pecora con muesli e una banana." },
                    merenda: { nome: "Kiwi e Mandorle", grammatura: "150g + 30g", descrizione: "Due kiwi e mandorle secche." },
                    spuntino_extra: { nome: "Semi di zucca", grammatura: "20g", descrizione: "Spuntino extra durante la giornata." },
                    pranzo: { nome: "Penne Senatore Cappelli con Tonno e Zucchine", grammatura: "80g + 60g + 200g", descrizione: "Penne con tonno al naturale e zucchine. Condire con 20g olio EVO." },
                    cena: { nome: "Pesce spada, Insalata di pomodori, Banana", grammatura: "150g + 200g + 150g", descrizione: "Pesce spada alla griglia con insalata di pomodori. Concludere con una banana." }
                },
                 gio: {
                    colazione: { nome: "Pane secco, burro, marmellata e Kiwi", grammatura: "90g + 150g", descrizione: "Pane secco con burro di centrifuga, marmellata e due kiwi." },
                    merenda: { nome: "Mirtilli e Semi di zucca", grammatura: "125g + 20g", descrizione: "Una coppetta di mirtilli e semi di zucca." },
                    spuntino_extra: { nome: "Semi di zucca", grammatura: "20g", descrizione: "Spuntino extra durante la giornata." },
                    pranzo: { nome: "Farro con Piselli e Zucchine", grammatura: "80g + 60g + 200g", descrizione: "Farro con piselli e zucchine saltate. Condire con 20g olio EVO e 5g di olio di lino." },
                    cena: { nome: "Sgombro al forno, Peperoni e Mirtilli", grammatura: "150g + 150g + 125g", descrizione: "Sgombro al forno con peperoni grigliati. Concludere con mirtilli." }
                },
                ven: {
                    colazione: { nome: "Latte di vacca, Muesli e Banana", grammatura: "200g + 30g + 150g", descrizione: "Latte scremato con muesli e una banana." },
                    merenda: { nome: "Banana e Noci", grammatura: "150g + 30g", descrizione: "Una banana fresca e noci." },
                    spuntino_extra: { nome: "Semi di zucca", grammatura: "20g", descrizione: "Spuntino extra durante la giornata." },
                    pranzo: { nome: "Riso basmati con Cozze e Fagiolini", grammatura: "80g + 60g + 100g", descrizione: "Riso con cozze e fagiolini. Condire con 20g olio EVO." },
                    cena: { nome: "Tonno fresco, Asparagi e Kiwi", grammatura: "150g + 100g + 150g", descrizione: "Trancio di tonno fresco con asparagi. Concludere con due kiwi." }
                },
                sab: {
                    colazione: { nome: "Pane secco, burro, marmellata e Mirtilli", grammatura: "90g + 125g", descrizione: "Pane secco con burro, marmellata e mirtilli." },
                    merenda: { nome: "Fiocchi di latte", grammatura: "85g", descrizione: "Una porzione di fiocchi di latte freschi." },
                    spuntino_extra: { nome: "Semi di zucca", grammatura: "20g", descrizione: "Spuntino extra durante la giornata." },
                    pranzo: { nome: "Pasta Senatore Cappelli con Fagioli e Carote", grammatura: "80g + 60g + 100g", descrizione: "Pasta e fagioli con carote. Condire con 20g olio EVO e 5g di olio di lino." },
                    cena: { nome: "Vitellone, Funghi e Banana", grammatura: "150g + 150g + 150g", descrizione: "Bistecca di vitellone ai ferri con funghi trifolati. Concludere con una banana." }
                },
                dom: {
                    colazione: { nome: "Ricotta di vacca con Kiwi", grammatura: "80g + 150g", descrizione: "Ricotta fresca accompagnata da due kiwi." },
                    merenda: { nome: "Banana e Mandorle", grammatura: "150g + 30g", descrizione: "Una banana e mandorle." },
                    spuntino_extra: { nome: "Semi di zucca", grammatura: "20g", descrizione: "Spuntino extra durante la giornata." },
                    pranzo: { nome: "Piatto libero", grammatura: "Porzione media", descrizione: "Goditi un pasto libero, ad esempio Riso Venere ai frutti di mare." },
                    cena: { nome: "Minestra di verdure e legumi, Mirtilli", grammatura: "Piatto abbondante + 125g", descrizione: "Passato di verdure (zucca, carote, zucchine) con lenticchie (80g). Concludere con mirtilli." }
                }
            },
            settimana3: {
                lun: {
                    colazione: { nome: "Yogurt greco, Muesli e Kiwi", grammatura: "125g + 30g + 150g", descrizione: "Yogurt greco con muesli e kiwi a fette." },
                    merenda: { nome: "Banana e Anacardi", grammatura: "150g + 30g", descrizione: "Fette di banana e anacardi." },
                    spuntino_extra: { nome: "Semi di zucca", grammatura: "20g", descrizione: "Spuntino extra durante la giornata." },
                    pranzo: { nome: "Pasta Senatore Cappelli con Ceci e Broccoletti", grammatura: "80g + 60g + 60g", descrizione: "Pasta con ceci e broccoletti di rapa saltati." },
                    cena: { nome: "Petto di pollo, Carote e Banana", grammatura: "150g + 100g + 150g", descrizione: "Pollo grigliato con carote julienne. Concludere con una banana." }
                },
                mar: {
                    colazione: { nome: "Pane secco, burro, marmellata e Banana", grammatura: "90g + 150g", descrizione: "Pane secco con burro, marmellata e una banana." },
                    merenda: { nome: "Kiwi e Noci", grammatura: "150g + 30g", descrizione: "Due kiwi e noci secche." },
                    spuntino_extra: { nome: "Semi di zucca", grammatura: "20g", descrizione: "Spuntino extra durante la giornata." },
                    pranzo: { nome: "Riso nero Venere con Lenticchie e Peperoni", grammatura: "80g + 60g + 150g", descrizione: "Riso venere con lenticchie e peperoni arrostiti." },
                    cena: { nome: "Salmone, Fagiolini e Kiwi", grammatura: "150g + 100g + 150g", descrizione: "Salmone al vapore con fagiolini. Concludere con due kiwi." }
                },
                mer: {
                    colazione: { nome: "Ricotta di vacca, Muesli e Mirtilli", grammatura: "80g + 30g + 125g", descrizione: "Ricotta fresca con muesli e mirtilli." },
                    merenda: { nome: "Banana e Mandorle", grammatura: "150g + 30g", descrizione: "Una banana e mandorle." },
                    spuntino_extra: { nome: "Semi di zucca", grammatura: "20g", descrizione: "Spuntino extra durante la giornata." },
                    pranzo: { nome: "Farro con Sgombro e Pomodorini", grammatura: "80g + 60g + 200g", descrizione: "Insalata di farro con sgombro e pomodorini." },
                    cena: { nome: "Pesce spada, Zucchine e Banana", grammatura: "150g + 200g + 150g", descrizione: "Trancio di pesce spada con zucchine grigliate. Concludere con una banana." }
                },
                 gio: {
                    colazione: { nome: "Latte di pecora, Muesli e Banana", grammatura: "200g + 30g + 150g", descrizione: "Tazza di latte di pecora con muesli e banana." },
                    merenda: { nome: "Kiwi e Nocciole", grammatura: "150g + 30g", descrizione: "Due kiwi e nocciole." },
                    spuntino_extra: { nome: "Semi di zucca", grammatura: "20g", descrizione: "Spuntino extra durante la giornata." },
                    pranzo: { nome: "Farro con Fagioli e Zucca", grammatura: "80g + 60g + 200g", descrizione: "Insalata di farro con fagioli e zucca al forno." },
                    cena: { nome: "Tacchino, Spinaci e Mirtilli", grammatura: "150g + 100g + 125g", descrizione: "Fesa di tacchino con spinaci freschi. Concludere con mirtilli." }
                },
                ven: {
                    colazione: { nome: "Pane secco, burro, marmellata e Kiwi", grammatura: "90g + 150g", descrizione: "Pane secco con burro, marmellata e kiwi." },
                    merenda: { nome: "Mirtilli e Semi di girasole", grammatura: "125g + 20g", descrizione: "Coppetta di mirtilli e semi di girasole." },
                    spuntino_extra: { nome: "Semi di zucca", grammatura: "20g", descrizione: "Spuntino extra durante la giornata." },
                    pranzo: { nome: "Riso basmati con Vongole e Zucchine", grammatura: "80g + 60g + 200g", descrizione: "Riso con vongole al naturale e zucchine." },
                    cena: { nome: "Sogliola al limone, Asparagi, Banana", grammatura: "150g + 100g + 150g", descrizione: "Filetti di sogliola con limone e asparagi. Concludere con una banana." }
                },
                sab: {
                    colazione: { nome: "Ricotta di vacca con Banana", grammatura: "80g + 150g", descrizione: "Ricotta fresca con una banana a fette." },
                    merenda: { nome: "Fiocchi di latte", grammatura: "85g", descrizione: "Una porzione di fiocchi di latte." },
                    spuntino_extra: { nome: "Semi di zucca", grammatura: "20g", descrizione: "Spuntino extra durante la giornata." },
                    pranzo: { nome: "Grano saraceno con ragù di lenticchie", grammatura: "80g + 100g", descrizione: "Grano saraceno con ragù di lenticchie e verdure." },
                    cena: { nome: "Triglie alla livornese, Kiwi", grammatura: "150g + 150g", descrizione: "Triglie con pomodoro. Concludere con due kiwi." }
                },
                dom: {
                    colazione: { nome: "Latte di capra, Muesli e Mirtilli", grammatura: "200g + 30g + 125g", descrizione: "Latte di capra con muesli e mirtilli." },
                    merenda: { nome: "Banana e Arachidi tostate", grammatura: "150g + 30g", descrizione: "Una banana e arachidi." },
                    spuntino_extra: { nome: "Semi di zucca", grammatura: "20g", descrizione: "Spuntino extra durante la giornata." },
                    pranzo: { nome: "Piatto libero", grammatura: "A piacere", descrizione: "Goditi un pasto libero, magari una pizza con farina Senatore Cappelli." },
                    cena: { nome: "Orata, Piselli e Banana", grammatura: "150g + 240g + 150g", descrizione: "Orata al forno con piselli freschi in umido. Concludere con una banana." }
                }
            },
            settimana4: {
                 lun: {
                    colazione: { nome: "Yogurt greco, Muesli e Banana", grammatura: "125g + 30g + 150g", descrizione: "Yogurt greco con muesli e banana." },
                    merenda: { nome: "Kiwi e Noci", grammatura: "150g + 30g", descrizione: "Due kiwi e noci." },
                    spuntino_extra: { nome: "Semi di zucca", grammatura: "20g", descrizione: "Spuntino extra durante la giornata." },
                    pranzo: { nome: "Grano saraceno con Ceci e Peperoni", grammatura: "80g + 60g + 150g", descrizione: "Grano saraceno con ceci e peperoni grigliati." },
                    cena: { nome: "Salmone al vapore, Broccoletti e Kiwi", grammatura: "150g + 200g + 150g", descrizione: "Salmone cotto al vapore con broccoletti. Concludere con due kiwi." }
                },
                mar: {
                    colazione: { nome: "Ricotta di pecora con Mirtilli", grammatura: "80g + 125g", descrizione: "Ricotta di pecora fresca con mirtilli." },
                    merenda: { nome: "Banana e Nocciole", grammatura: "150g + 30g", descrizione: "Una banana e nocciole." },
                    spuntino_extra: { nome: "Semi di zucca", grammatura: "20g", descrizione: "Spuntino extra durante la giornata." },
                    pranzo: { nome: "Riso basmati con Lenticchie e Fagiolini", grammatura: "80g + 60g + 100g", descrizione: "Riso con lenticchie e fagiolini." },
                    cena: { nome: "Fegato di bovino, Cipolle e Banana", grammatura: "150g + 100g + 150g", descrizione: "Fegato alla veneziana (con cipolle). Concludere con una banana." }
                },
                mer: {
                    colazione: { nome: "Ricotta di pecora, Muesli e Kiwi", grammatura: "80g + 30g + 150g", descrizione: "Ricotta di pecora con muesli e kiwi." },
                    merenda: { nome: "Banana e Mandorle", grammatura: "150g + 30g", descrizione: "Banana e mandorle." },
                    spuntino_extra: { nome: "Semi di zucca", grammatura: "20g", descrizione: "Spuntino extra durante la giornata." },
                    pranzo: { nome: "Penne Senatore Cappelli con Tonno e Zucchine", grammatura: "80g + 60g + 200g", descrizione: "Pasta con tonno al naturale e zucchine." },
                    cena: { nome: "Tacchino, Funghi e Mirtilli", grammatura: "150g + 150g + 125g", descrizione: "Fesa di tacchino con funghi trifolati. Concludere con mirtilli." }
                },
                 gio: {
                    colazione: { nome: "Pane secco, burro, marmellata e Banana", grammatura: "90g + 150g", descrizione: "Pane secco con burro, marmellata e banana." },
                    merenda: { nome: "Mirtilli e Semi di zucca", grammatura: "125g + 20g", descrizione: "Mirtilli e semi di zucca." },
                    spuntino_extra: { nome: "Semi di zucca", grammatura: "20g", descrizione: "Spuntino extra durante la giornata." },
                    pranzo: { nome: "Farro con Piselli e Zucca gialla", grammatura: "80g + 60g + 200g", descrizione: "Farro con piselli e zucca." },
                    cena: { nome: "Sarda a beccafico, Lattuga e Kiwi", grammatura: "150g + 100g + 150g", descrizione: "Sarde a beccafico con lattuga. Concludere con due kiwi." }
                },
                ven: {
                    colazione: { nome: "Latte di vacca, Muesli e Kiwi", grammatura: "200g + 30g + 150g", descrizione: "Latte scremato con muesli e kiwi." },
                    merenda: { nome: "Banana e Nocciole", grammatura: "150g + 30g", descrizione: "Banana e nocciole." },
                    spuntino_extra: { nome: "Semi di zucca", grammatura: "20g", descrizione: "Spuntino extra durante la giornata." },
                    pranzo: { nome: "Riso basmati con Cozze e Pomodorini", grammatura: "80g + 60g + 200g", descrizione: "Riso con cozze e pomodorini freschi." },
                    cena: { nome: "Salmone, Agretti e Banana", grammatura: "150g + 100g + 150g", descrizione: "Salmone al vapore con agretti. Concludere con una banana." }
                },
                sab: {
                    colazione: { nome: "Pane secco, burro, marmellata e Mirtilli", grammatura: "90g + 125g", descrizione: "Pane secco con burro, marmellata e mirtilli." },
                    merenda: { nome: "Fiocchi di latte", grammatura: "85g", descrizione: "Una porzione di fiocchi di latte." },
                    spuntino_extra: { nome: "Semi di zucca", grammatura: "20g", descrizione: "Spuntino extra durante la giornata." },
                    pranzo: { nome: "Pasta Senatore Cappelli con Fagioli Borlotti", grammatura: "80g + 120g", descrizione: "Pasta e fagioli borlotti freschi." },
                    cena: { nome: "Bistecca di maiale, Peperoni e Kiwi", grammatura: "150g + 150g + 150g", descrizione: "Bistecca di maiale con peperoni arrostiti. Concludere con due kiwi." }
                },
                dom: {
                    colazione: { nome: "Ricotta di pecora con Banana", grammatura: "80g + 150g", descrizione: "Ricotta fresca con una banana." },
                    merenda: { nome: "Kiwi e Mandorle", grammatura: "150g + 30g", descrizione: "Kiwi e mandorle." },
                    spuntino_extra: { nome: "Semi di zucca", grammatura: "20g", descrizione: "Spuntino extra durante la giornata." },
                    pranzo: { nome: "Piatto libero", grammatura: "A piacere", descrizione: "Pasto libero per concludere il mese." },
                    cena: { nome: "Passato di verdure con ceci, Mirtilli", grammatura: "Piatto abbondante + 125g", descrizione: "Passato di verdure miste con ceci (80g). Concludere con mirtilli." }
                }
            }
        };
        
        const shoppingLists = {
            settimana1: {
                "Frutta": [ { name: "Banana", qty: 900, unit: "g" }, { name: "Kiwi", qty: 750, unit: "g" }, { name: "Mirtilli", qty: 500, unit: "g" } ],
                "Verdura": [ { name: "Zucchine", qty: 600, unit: "g" }, { name: "Bieta", qty: 100, unit: "g" }, { name: "Carote", qty: 100, unit: "g" }, { name: "Spinaci", qty: 100, unit: "g" }, { name: "Pomodori", qty: 200, unit: "g" }, { name: "Broccoletti", qty: 200, unit: "g" }, { name: "Zucca gialla", qty: 200, unit: "g" }, { name: "Asparagi", qty: 100, unit: "g" }, { name: "Peperoni", qty: 150, unit: "g" }, { name: "Funghi prataioli", qty: 150, unit: "g" }, { name: "Lattuga", qty: 100, unit: "g" }, { name: "Fagiolini", qty: 100, unit: "g" } ],
                "Carboidrati": [ { name: "Pasta Senatore Cappelli", qty: 160, unit: "g" }, { name: "Pane secco/integrale", qty: 180, unit: "g" }, { name: "Riso basmati", qty: 80, unit: "g" }, { name: "Farro", qty: 80, unit: "g" }, { name: "Grano saraceno", qty: 160, unit: "g" }, { name: "Riso nero Venere", qty: 80, unit: "g" } ],
                "Proteine": [ { name: "Ceci secchi", qty: 60, unit: "g" }, { name: "Petto di tacchino", qty: 150, unit: "g" }, { name: "Lenticchie secche", qty: 60, unit: "g" }, { name: "Sgombro", qty: 210, unit: "g" }, { name: "Piselli freschi", qty: 60, unit: "g" }, { name: "Salmone fresco", qty: 150, unit: "g" }, { name: "Fagioli secchi", qty: 60, unit: "g" }, { name: "Vitellone", qty: 150, unit: "g" }, { name: "Orata fresca", qty: 150, unit: "g" }, { name: "Bistecca di maiale", qty: 150, unit: "g" }, { name: "Vongole", qty: 60, unit: "g" }, { name: "Trota", qty: 150, unit: "g" } ],
                "Latticini e Alternative": [ { name: "Yogurt greco intero", qty: 125, unit: "g" }, { name: "Ricotta di vacca", qty: 80, unit: "g" }, { name: "Latte di capra", qty: 200, unit: "ml" }, { name: "Ricotta di pecora", qty: 80, unit: "g" }, { name: "Latte di pecora", qty: 200, unit: "ml" }, { name: "Fiocchi di latte", qty: 85, unit: "g" } ],
                "Cereali e Altro": [ { name: "Muesli", qty: 150, unit: "g" }, { name: "Burro di centrifuga", qty: 1, unit: "conf" }, { name: "Marmellata biologica", qty: 1, unit: "conf" } ],
                "Frutta Secca e Semi": [ { name: "Mandorle", qty: 60, unit: "g" }, { name: "Noci", qty: 60, unit: "g" }, { name: "Anacardi", qty: 30, unit: "g" }, { name: "Nocciole", qty: 30, unit: "g" }, { name: "Semi di girasole", qty: 20, unit: "g" }, { name: "Semi di zucca", qty: 140, unit: "g" } ]
            },
            settimana2: {
                 "Frutta": [ { name: "Kiwi", qty: 900, unit: "g" }, { name: "Banana", qty: 900, unit: "g" }, { name: "Mirtilli", qty: 750, unit: "g" } ],
                "Verdura": [ { name: "Zucchine", qty: 600, unit: "g" }, { name: "Patate", qty: 200, unit: "g" }, { name: "Zucca gialla", qty: 200, unit: "g" }, { name: "Agretti", qty: 100, unit: "g" }, { name: "Pomodori", qty: 200, unit: "g" }, { name: "Peperoni", qty: 150, unit: "g" }, { name: "Asparagi", qty: 100, unit: "g" }, { name: "Carote", qty: 100, unit: "g" }, { name: "Funghi", qty: 150, unit: "g" }, { name: "Fagiolini", qty: 100, unit: "g" }, { name: "Prezzemolo", qty: 1, unit: "mazzetto" } ],
                "Carboidrati": [ { name: "Grano saraceno", qty: 80, unit: "g" }, { name: "Pane secco/integrale", qty: 180, unit: "g" }, { name: "Riso basmati", qty: 160, unit: "g" }, { name: "Penne Senatore Cappelli", qty: 80, unit: "g" }, { name: "Farro", qty: 80, unit: "g" }, { name: "Pasta Senatore Cappelli", qty: 80, unit: "g" } ],
                "Proteine": [ { name: "Ceci secchi", qty: 60, unit: "g" }, { name: "Polpo", qty: 200, unit: "g" }, { name: "Lenticchie secche", qty: 140, unit: "g" }, { name: "Fegato di bovino", qty: 150, unit: "g" }, { name: "Tonno al naturale", qty: 60, unit: "g" }, { name: "Pesce spada", qty: 150, unit: "g" }, { name: "Piselli freschi", qty: 60, unit: "g" }, { name: "Sgombro", qty: 150, unit: "g" }, { name: "Cozze", qty: 60, unit: "g" }, { name: "Tonno fresco", qty: 150, unit: "g" }, { name: "Fagioli secchi", qty: 60, unit: "g" }, { name: "Vitellone", qty: 150, unit: "g" } ],
                "Latticini e Alternative": [ { name: "Yogurt greco", qty: 125, unit: "g" }, { name: "Ricotta di vacca", qty: 160, unit: "g" }, { name: "Ricotta di pecora", qty: 80, unit: "g" }, { name: "Latte di vacca", qty: 200, unit: "ml" }, { name: "Fiocchi di latte", qty: 85, unit: "g" } ],
                "Cereali e Altro": [ { name: "Muesli", qty: 90, unit: "g" }, { name: "Burro di centrifuga", qty: 1, unit: "conf" }, { name: "Marmellata biologica", qty: 1, unit: "conf" } ],
                "Frutta Secca e Semi": [ { name: "Nocciole", qty: 30, unit: "g" }, { name: "Mandorle", qty: 60, unit: "g" }, { name: "Semi di zucca", qty: 160, unit: "g" }, { name: "Noci", qty: 30, unit: "g" } ]
            },
            settimana3: {
                "Frutta": [ { name: "Kiwi", qty: 750, unit: "g" }, { name: "Banana", qty: 1050, unit: "g" }, { name: "Mirtilli", qty: 375, unit: "g" } ],
                "Verdura": [ { name: "Broccoletti", qty: 60, unit: "g" }, { name: "Carote", qty: 100, unit: "g" }, { name: "Peperoni", qty: 150, unit: "g" }, { name: "Fagiolini", qty: 100, unit: "g" }, { name: "Pomodorini", qty: 200, unit: "g" }, { name: "Zucchine", qty: 400, unit: "g" }, { name: "Spinaci", qty: 100, unit: "g" }, { name: "Zucca gialla", qty: 200, unit: "g" }, { name: "Asparagi", qty: 100, unit: "g" }, { name: "Piselli freschi", qty: 240, unit: "g" } ],
                "Carboidrati": [ { name: "Pasta Senatore Cappelli", qty: 80, unit: "g" }, { name: "Pane secco/integrale", qty: 180, unit: "g" }, { name: "Riso nero Venere", qty: 80, unit: "g" }, { name: "Farro", qty: 160, unit: "g" }, { name: "Riso basmati", qty: 80, unit: "g" }, { name: "Grano saraceno", qty: 80, unit: "g" } ],
                "Proteine": [ { name: "Ceci secchi", qty: 60, unit: "g" }, { name: "Petto di pollo", qty: 150, unit: "g" }, { name: "Lenticchie secche", qty: 160, unit: "g" }, { name: "Salmone fresco", qty: 150, unit: "g" }, { name: "Sgombro", qty: 60, unit: "g" }, { name: "Pesce spada", qty: 150, unit: "g" }, { name: "Fesa di tacchino", qty: 150, unit: "g" }, { name: "Vongole", qty: 60, unit: "g" }, { name: "Sogliola", qty: 150, unit: "g" }, { name: "Triglie", qty: 150, unit: "g" }, { name: "Orata", qty: 150, unit: "g" } ],
                "Latticini e Alternative": [ { name: "Yogurt greco", qty: 125, unit: "g" }, { name: "Ricotta di vacca", qty: 160, unit: "g" }, { name: "Latte di pecora", qty: 200, unit: "ml" }, { name: "Fiocchi di latte", qty: 85, unit: "g" }, { name: "Latte di capra", qty: 200, unit: "ml" } ],
                "Cereali e Altro": [ { name: "Muesli", qty: 120, unit: "g" }, { name: "Burro di centrifuga", qty: 1, unit: "conf" }, { name: "Marmellata biologica", qty: 1, unit: "conf" } ],
                "Frutta Secca e Semi": [ { name: "Anacardi", qty: 30, unit: "g" }, { name: "Noci", qty: 30, unit: "g" }, { name: "Mandorle", qty: 30, unit: "g" }, { name: "Nocciole", qty: 30, unit: "g" }, { name: "Semi di girasole", qty: 20, unit: "g" }, { name: "Arachidi tostate", qty: 30, unit: "g" }, { name: "Semi di zucca", qty: 140, unit: "g" } ]
            },
            settimana4: {
                "Frutta": [ { name: "Banana", qty: 900, unit: "g" }, { name: "Kiwi", qty: 900, unit: "g" }, { name: "Mirtilli", qty: 625, unit: "g" } ],
                "Verdura": [ { name: "Peperoni", qty: 300, unit: "g" }, { name: "Broccoletti", qty: 200, unit: "g" }, { name: "Cipolle", qty: 100, unit: "g" }, { name: "Fagiolini", qty: 100, unit: "g" }, { name: "Funghi", qty: 150, unit: "g" }, { name: "Lattuga", qty: 100, unit: "g" }, { name: "Agretti", qty: 100, unit: "g" }, { name: "Zucchine", qty: 200, unit: "g" }, { name: "Zucca gialla", qty: 200, unit: "g" }, { name: "Pomodorini", qty: 200, unit: "g" } ],
                "Carboidrati": [ { name: "Grano saraceno", qty: 80, unit: "g" }, { name: "Pane secco/integrale", qty: 180, unit: "g" }, { name: "Riso basmati", qty: 160, unit: "g" }, { name: "Penne Senatore Cappelli", qty: 80, unit: "g" }, { name: "Farro", qty: 80, unit: "g" }, { name: "Pasta Senatore Cappelli", qty: 80, unit: "g" } ],
                "Proteine": [ { name: "Ceci secchi", qty: 140, unit: "g" }, { name: "Salmone fresco", qty: 300, unit: "g" }, { name: "Lenticchie secche", qty: 60, unit: "g" }, { name: "Fegato di bovino", qty: 150, unit: "g" }, { name: "Tonno al naturale", qty: 60, unit: "g" }, { name: "Fesa di tacchino", qty: 150, unit: "g" }, { name: "Sarde", qty: 150, unit: "g" }, { name: "Cozze", qty: 60, unit: "g" }, { name: "Fagioli Borlotti freschi", qty: 120, unit: "g" }, { name: "Bistecca di maiale", qty: 150, unit: "g" }, { name: "Piselli freschi", qty: 60, unit: "g" } ],
                "Latticini e Alternative": [ { name: "Yogurt greco", qty: 125, unit: "g" }, { name: "Ricotta di pecora", qty: 240, unit: "g" }, { name: "Latte di vacca", qty: 200, unit: "ml" }, { name: "Fiocchi di latte", qty: 85, unit: "g" } ],
                "Cereali e Altro": [ { name: "Muesli", qty: 90, unit: "g" }, { name: "Burro di centrifuga", qty: 1, unit: "conf" }, { name: "Marmellata biologica", qty: 1, unit: "conf" } ],
                "Frutta Secca e Semi": [ { name: "Noci", qty: 30, unit: "g" }, { name: "Nocciole", qty: 60, unit: "g" }, { name: "Mandorle", qty: 60, unit: "g" }, { name: "Semi di zucca", qty: 160, unit: "g" } ]
            }
        };

        const mealTypes = {
            colazione: "Colazione", merenda: "Spuntino", spuntino_extra: "Spuntino Extra", pranzo: "Pranzo", cena: "Cena"
        };
        const dayNames = {
            lun: 'Lunedì', mar: 'Martedì', mer: 'Mercoledì', gio: 'Giovedì', ven: 'Venerdì', sab: 'Sabato', dom: 'Domenica'
        };
        const dayKeys = ['lun', 'mar', 'mer', 'gio', 'ven', 'sab', 'dom'];

        let activeWeek = 'settimana1';
        let activeDayKey = 'lun';
        let currentView = 'plan'; 

        const weekNav = document.getElementById('week-nav');
        const dayNav = document.getElementById('day-nav');
        const planViewContainer = document.getElementById('plan-view-container');
        const shoppingListContainer = document.getElementById('list-view-container');
        const planViewWrapper = document.getElementById('plan-view-wrapper');
        const contentContainer = document.getElementById('content-container');
        
        const planViewBtn = document.getElementById('plan-view-btn');
        const listViewBtn = document.getElementById('list-view-btn');
        
        function createMealCard(mealKey, mealData) {
             const bgColor = mealKey === 'spuntino_extra' ? 'bg-green-600' : 'bg-blue-600';
            return `<div class="meal-card bg-white rounded-xl shadow-lg overflow-hidden flex flex-col md:flex-row mb-6 hover:shadow-xl hover:transform hover:-translate-y-1">
                        <div class="md:w-1/3 ${bgColor} text-white p-6 flex flex-col justify-center items-center">
                            <h3 class="text-xl font-bold">${mealTypes[mealKey]}</h3>
                        </div>
                        <div class="p-6 md:w-2/3">
                            <h4 class="font-bold text-lg text-gray-900">${mealData.nome}</h4>
                            <p class="text-gray-500 font-medium mb-2">${mealData.grammatura}</p>
                            <p class="text-gray-700">${mealData.descrizione}</p>
                        </div>
                    </div>`;
        }

        function buildDayContent(weekKey, dayKey) {
            const dayData = mealPlan[weekKey]?.[dayKey];
            if (!dayData) return '<p class="text-center text-red-500">Nessun dato disponibile.</p>';
            
            let content = `<h2 class="text-2xl font-bold text-center mb-6 text-blue-800">${dayNames[dayKey]} - ${weekKey.replace('settimana', 'Settimana ')}</h2>`;
            content += Object.keys(mealTypes).map(mealKey => dayData[mealKey] ? createMealCard(mealKey, dayData[mealKey]) : '').join('');
            return content;
        }

        function displayShoppingList(weekKey) {
            const listData = shoppingLists[weekKey];
            activeWeek = weekKey;
            if (!listData) {
                shoppingListContainer.innerHTML = '<p class="text-center text-red-500">Nessun dato disponibile.</p>';
                return;
            }

            let content = `<h2 class="text-2xl font-bold text-center mb-8 text-blue-800">Lista della Spesa - ${weekKey.replace('settimana', 'Settimana ')}</h2>`;
            content += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">';

            for (const category in listData) {
                content += `<div class="bg-white p-6 rounded-xl shadow-md">
                                <h3 class="text-lg font-bold text-blue-700 border-b-2 border-blue-200 pb-2 mb-4">${category}</h3>
                                <div class="space-y-3">`;
                listData[category].forEach((item, index) => {
                    const itemId = `${weekKey}-${category.replace(/\s+/g, '')}-${index}`;
                    const itemText = `${item.name} <span class="text-gray-500 font-medium">(${item.qty} ${item.unit})</span>`;
                    content += `<div class="shopping-item flex items-center">
                                    <input type="checkbox" id="${itemId}" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer">
                                    <label for="${itemId}" class="ml-3 text-gray-700 cursor-pointer">${itemText}</label>
                                </div>`;
                });
                content += `</div></div>`;
            }

            content += '</div>';
            shoppingListContainer.innerHTML = content;
            updateActiveButtons();
        }

        function updateStickyHeader(weekKey, dayKey) {
            document.getElementById('sticky-week').textContent = weekKey.replace('settimana', 'Settimana ');
            document.getElementById('sticky-day').textContent = dayNames[dayKey];
        }

        function toggleView(view) {
            const stickyHeader = document.getElementById('sticky-header');
            currentView = view;
            if (view === 'plan') {
                planViewWrapper.classList.remove('hidden');
                shoppingListContainer.classList.add('hidden');
                planViewBtn.classList.add('active');
                listViewBtn.classList.remove('active');
                initDayCards();
            } else {
                planViewWrapper.classList.add('hidden');
                shoppingListContainer.classList.remove('hidden');
                planViewBtn.classList.remove('active');
                listViewBtn.classList.add('active');
                stickyHeader.classList.remove('visible');
                displayShoppingList(activeWeek);
            }
        }
        
        function handleWeekChange(weekKey, dayKey) {
            activeWeek = weekKey;
            activeDayKey = dayKey;
            if (currentView === 'plan') {
                initDayCards();
            } else {
                displayShoppingList(weekKey);
            }
        }

        function updateActiveButtons() {
            document.querySelectorAll('#week-nav .nav-button').forEach(button => {
                button.classList.toggle('active', button.dataset.week === activeWeek);
            });
            if (currentView === 'plan') {
                document.querySelectorAll('#day-nav .day-nav-button').forEach(button => {
                    button.classList.toggle('active', button.dataset.day === activeDayKey);
                });
            }
        }
        
        function setupNavigation() {
            planViewBtn.onclick = () => toggleView('plan');
            listViewBtn.onclick = () => toggleView('list');
            
            Object.keys(mealPlan).forEach((weekKey, index) => {
                const button = document.createElement('button');
                button.textContent = `Settimana ${index + 1}`;
                button.dataset.week = weekKey;
                button.className = 'nav-button px-4 py-2 rounded-lg text-sm sm:text-base font-medium text-gray-700 hover:bg-blue-100 transition-colors duration-200';
                button.onclick = () => handleWeekChange(weekKey, activeDayKey);
                weekNav.appendChild(button);
            });
            
            dayKeys.forEach(dayKey => {
                const button = document.createElement('button');
                button.textContent = dayNames[dayKey].substring(0,3);
                button.dataset.day = dayKey;
                button.className = 'day-nav-button px-3 py-2 text-sm sm:text-base border-2 border-gray-300 rounded-lg font-semibold text-gray-600 hover:bg-gray-200 transition-colors duration-200';
                button.onclick = () => {
                    if (dayKey !== activeDayKey) {
                        const currentIndex = dayKeys.indexOf(activeDayKey);
                        const nextIndex = dayKeys.indexOf(dayKey);
                        const direction = nextIndex > currentIndex ? 'next' : 'previous';
                        navigateDay(direction, dayKey);
                    }
                };
                dayNav.appendChild(button);
            });
        }
        
        // --- GESTIONE SCHEDE E SWIPE INTERATTIVO ---
        let currentCard, nextCard, prevCard;
        let touchStartX = 0;
        let currentTranslate = 0;
        let isDragging = false;

        function initDayCards() {
            planViewContainer.innerHTML = `
                <div id="prev-card" class="day-card"></div>
                <div id="current-card" class="day-card"></div>
                <div id="next-card" class="day-card"></div>
            `;
            currentCard = document.getElementById('current-card');
            nextCard = document.getElementById('next-card');
            prevCard = document.getElementById('prev-card');
            
            positionCards();
            updateActiveButtons();
            updateStickyHeader(activeWeek, activeDayKey);
        }

        function positionCards() {
            const currentIndex = dayKeys.indexOf(activeDayKey);
            const prevIndex = (currentIndex - 1 + dayKeys.length) % dayKeys.length;
            const nextIndex = (currentIndex + 1) % dayKeys.length;

            currentCard.innerHTML = buildDayContent(activeWeek, dayKeys[currentIndex]);
            prevCard.innerHTML = buildDayContent(activeWeek, dayKeys[prevIndex]);
            nextCard.innerHTML = buildDayContent(activeWeek, dayKeys[nextIndex]);
            
            currentCard.style.transform = 'translateX(0) rotateY(0)';
            prevCard.style.transform = 'translateX(-100%) rotateY(0)';
            nextCard.style.transform = 'translateX(100%) rotateY(0)';
        }

        function navigateDay(direction, targetDayKey = null) {
            isDragging = false; // Termina il trascinamento
            
            const currentIndex = dayKeys.indexOf(activeDayKey);
            let nextIndex;

            if (targetDayKey) {
                 nextIndex = dayKeys.indexOf(targetDayKey);
            } else {
                 nextIndex = direction === 'next'
                ? (currentIndex + 1) % dayKeys.length
                : (currentIndex - 1 + dayKeys.length) % dayKeys.length;
            }

            activeDayKey = dayKeys[nextIndex];
            
            // Applica transizione
            [currentCard, prevCard, nextCard].forEach(el => el.classList.add('with-transition'));
            
            if (direction === 'next') {
                currentCard.style.transform = 'translateX(-100%) rotateY(-30deg)';
                nextCard.style.transform = 'translateX(0) rotateY(0)';
            } else {
                currentCard.style.transform = 'translateX(100%) rotateY(30deg)';
                prevCard.style.transform = 'translateX(0) rotateY(0)';
            }
            
            // Dopo la transizione, riposiziona le schede
            setTimeout(() => {
                 [currentCard, prevCard, nextCard].forEach(el => el.classList.remove('with-transition'));
                initDayCards();
            }, 400);
        }


        planViewContainer.addEventListener('touchstart', (e) => {
            if (e.target.closest('.meal-card')) return; // Non avviare swipe se si tocca una card
            isDragging = true;
            touchStartX = e.touches[0].clientX;
            // Rimuove la transizione per un movimento diretto
            [currentCard, prevCard, nextCard].forEach(el => el.classList.add('no-transition'));
            currentTranslate = 0;
        }, { passive: true });

        planViewContainer.addEventListener('touchmove', (e) => {
            if (!isDragging) return;

            const currentX = e.touches[0].clientX;
            currentTranslate = currentX - touchStartX;
            const screenWidth = planViewContainer.offsetWidth;
            const rotation = (currentTranslate / screenWidth) * 30; // Max 30 gradi di rotazione

            // Muovi le schede in tempo reale
            currentCard.style.transform = `translateX(${currentTranslate}px) rotateY(${rotation}deg)`;
            
            if (currentTranslate > 0) { // dragging right
                prevCard.style.transform = `translateX(${-screenWidth + currentTranslate}px) rotateY(${rotation}deg)`;
                nextCard.style.transform = 'translateX(100%)';
            } else { // dragging left
                nextCard.style.transform = `translateX(${screenWidth + currentTranslate}px) rotateY(${rotation}deg)`;
                 prevCard.style.transform = 'translateX(-100%)';
            }

        }, { passive: true });

        planViewContainer.addEventListener('touchend', () => {
            if (!isDragging) return;
            isDragging = false;
            
            [currentCard, prevCard, nextCard].forEach(el => el.classList.remove('no-transition'));

            const threshold = planViewContainer.offsetWidth / 3;

            if (currentTranslate > threshold) {
                // Swipe a destra completato
                navigateDay('previous');
            } else if (currentTranslate < -threshold) {
                // Swipe a sinistra completato
                navigateDay('next');
            } else {
                // Snap-back: torna alla posizione originale
                 [currentCard, prevCard, nextCard].forEach(el => el.classList.add('with-transition'));
                positionCards();
                setTimeout(() => {
                     [currentCard, prevCard, nextCard].forEach(el => el.classList.remove('with-transition'));
                }, 400);
            }
            currentTranslate = 0;
        });

        // Sticky header visibility
        const appWrapper = document.getElementById('app-wrapper');
        const stickyHeader = document.getElementById('sticky-header');
        const headerThreshold = 150; 

        appWrapper.addEventListener('scroll', () => {
             if (currentView === 'plan') {
                 if (appWrapper.scrollTop > headerThreshold) {
                     stickyHeader.classList.add('visible');
                 } else {
                     stickyHeader.classList.remove('visible');
                 }
             }
        });


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const todayIndex = (new Date().getDay() + 6) % 7;
            activeDayKey = dayKeys[todayIndex];
            
            // Correzione nomi settimane
            const correctedMealPlan = {};
            const correctedShoppingLists = {};
            Object.keys(mealPlan).forEach((key, index) => {
                const newKey = `settimana${index + 1}`;
                correctedMealPlan[newKey] = mealPlan[key];
                correctedShoppingLists[newKey] = shoppingLists[key];
            });
            window.mealPlan = correctedMealPlan;
            window.shoppingLists = correctedShoppingLists;

            setupNavigation();
            toggleView('plan');
        });

    </script>

</body>
</html>
